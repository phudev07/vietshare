<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Danh mục - VietShare</title>
  <meta name="description" id="pageDescription" content="Danh sách bài viết về Zalo">
  <link rel="canonical" id="pageCanonical" href="https://vietshare.site/category.html">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <meta name="theme-color" content="#2563EB">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" id="ogUrl" content="https://vietshare.site/category.html">
  <meta property="og:title" id="ogTitle" content="Danh mục - VietShare">
  <meta property="og:description" id="ogDescription" content="Danh sách bài viết về Zalo">
  <meta property="og:image" content="https://vietshare.site/assets/og-image.png">
  <meta property="og:site_name" content="VietShare">
  <meta property="og:locale" content="vi_VN">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" id="twitterTitle" content="Danh mục - VietShare">
  <meta name="twitter:description" id="twitterDescription" content="Danh sách bài viết về Zalo">
  <meta name="twitter:image" content="https://vietshare.site/assets/og-image.png">
  
  <!-- Preload critical resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://firestore.googleapis.com">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="assets/css/style.css">
  
  <!-- Dark Mode -->
  <script src="js/dark-mode.js"></script>
  
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7476202315605832" crossorigin="anonymous"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container container-wide">
      <div class="header-inner">
        <a href="/" class="logo">VietShare</a>
        
        <nav class="nav">
          <a href="/category.html?platform=zalo-pc" id="navZaloPC">Zalo PC</a>
          <a href="/category.html?platform=zalo-web" id="navZaloWeb">Zalo Web</a>
          <a href="/category.html?platform=zalo-mobile" id="navZaloMobile">Zalo Mobile</a>
        </nav>
        
        <div class="search-box">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" class="search-input" id="searchInput" placeholder="Tìm kiếm mẹo, lỗi Zalo...">
        </div>
        
        <button class="theme-toggle" id="themeToggle" aria-label="Chuyển đổi dark mode">
          <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
          <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
        </button>
      </div>
    </div>
  </header>
  
  <!-- Main Content -->
  <main>
    <!-- Category Header -->
    <section class="hero" style="padding: var(--spacing-2xl) 0;">
      <div class="container">
        <h1 id="categoryTitle">Danh mục</h1>
        <p id="categoryDescription" style="margin-bottom: 0;"></p>
      </div>
    </section>
    
    <!-- Filter Tabs -->
    <section style="background: var(--color-bg); border-bottom: 1px solid var(--color-border);">
      <div class="container">
        <div class="filter-tabs" id="filterTabs">
          <a href="?type=all" class="filter-tab" data-type="all">Tất cả</a>
          <a href="?type=loi" class="filter-tab" data-type="loi">Lỗi</a>
          <a href="?type=vi-sao" class="filter-tab" data-type="vi-sao">Vì sao</a>
          <a href="?type=meo" class="filter-tab" data-type="meo">Mẹo</a>
          <a href="?type=huong-dan" class="filter-tab" data-type="huong-dan">Hướng dẫn</a>
        </div>
      </div>
    </section>
    
    <!-- Articles -->
    <section class="section">
      <div class="container">
        <div class="article-list" id="articlesList">
          <div class="loading">
            <div class="spinner"></div>
            <span>Đang tải...</span>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-logo">VietShare</div>
        <div class="footer-links">
          <a href="/about.html">Giới thiệu</a>
          <a href="/contact.html">Liên hệ</a>
          <a href="/privacy-policy.html">Chính sách bảo mật</a>
          <a href="/terms.html">Điều khoản</a>
        </div>
        <p class="footer-copyright">© 2026 VietShare. Mọi quyền được bảo lưu.</p>
      </div>
    </div>
  </footer>
  
  <script type="module">
    import { db, collection, getDocs, query, where, limit } from './js/firebase-config.js';
    
    const PLATFORM_DATA = {
      'zalo-pc': {
        title: 'Zalo PC',
        description: 'Hướng dẫn sử dụng, mẹo hay và cách khắc phục lỗi Zalo trên máy tính.'
      },
      'zalo-web': {
        title: 'Zalo Web',
        description: 'Hướng dẫn sử dụng, mẹo hay và cách khắc phục lỗi Zalo Web trên trình duyệt.'
      },
      'zalo-mobile': {
        title: 'Zalo Mobile',
        description: 'Hướng dẫn sử dụng, mẹo hay và cách khắc phục lỗi Zalo trên điện thoại.'
      }
    };
    
    const CATEGORY_LABELS = {
      'loi': 'Lỗi',
      'vi-sao': 'Vì sao',
      'meo': 'Mẹo',
      'huong-dan': 'Hướng dẫn'
    };
    
    // Get URL params
    const urlParams = new URLSearchParams(window.location.search);
    const platform = urlParams.get('platform') || '';
    const typeFilter = urlParams.get('type') || 'all';
    
    // Update page based on platform
    if (platform && PLATFORM_DATA[platform]) {
      const data = PLATFORM_DATA[platform];
      document.getElementById('pageTitle').textContent = `${data.title} - VietShare`;
      document.getElementById('categoryTitle').textContent = data.title;
      document.getElementById('categoryDescription').textContent = data.description;
      document.title = `${data.title} - Hướng dẫn, Mẹo, Khắc phục lỗi | VietShare`;
    } else {
      document.getElementById('categoryTitle').textContent = 'Tất cả bài viết';
      document.getElementById('categoryDescription').textContent = 'Danh sách tất cả bài viết về Zalo PC, Web và Mobile.';
    }
    
    // Update filter tabs with current params
    document.querySelectorAll('.filter-tab').forEach(tab => {
      const type = tab.dataset.type;
      let href = '?';
      if (platform) href += `platform=${platform}&`;
      if (type !== 'all') href += `type=${type}`;
      else href = href.slice(0, -1) || '?';
      tab.href = href || '/category.html';
      
      if (type === typeFilter) {
        tab.classList.add('active');
      }
    });
    
    // Highlight active nav
    if (platform) {
      const navId = 'nav' + platform.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('');
      const navEl = document.getElementById(navId);
      if (navEl) navEl.classList.add('active');
    }
    
    // Load articles
    async function loadArticles() {
      const container = document.getElementById('articlesList');
      
      try {
        const articlesRef = collection(db, 'articles');
        let constraints = [where('status', '==', 'published')];
        
        if (platform) {
          constraints.push(where('platform', '==', platform));
        }
        if (typeFilter !== 'all') {
          constraints.push(where('category', '==', typeFilter));
        }
        constraints.push(limit(20));
        
        const q = query(articlesRef, ...constraints);
        const snapshot = await getDocs(q);
        const articles = [];
        
        snapshot.forEach(doc => {
          articles.push({ id: doc.id, ...doc.data() });
        });
        
        // Sort by date
        articles.sort((a, b) => {
          const dateA = a.createdAt?.toDate?.() || new Date(0);
          const dateB = b.createdAt?.toDate?.() || new Date(0);
          return dateB - dateA;
        });
        
        renderArticles(container, articles);
      } catch (error) {
        console.error('Error loading articles:', error);
        container.innerHTML = '<p class="text-muted">Không thể tải bài viết.</p>';
      }
    }
    
    function renderArticles(container, articles) {
      if (articles.length === 0) {
        container.innerHTML = `
          <div class="no-data">
            <p class="no-data-text">Chưa có bài viết nào trong danh mục này.</p>
          </div>
        `;
        return;
      }
      
      // Default placeholder image
      const defaultThumb = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="140" height="95" fill="%23E2E8F0"%3E%3Crect width="140" height="95"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%2394A3B8" font-size="12"%3ENo Image%3C/text%3E%3C/svg%3E';
      
      container.innerHTML = articles.map(article => {
        const thumbSrc = (article.heroImage && article.heroImage.trim()) ? article.heroImage : defaultThumb;
        const categoryLabel = CATEGORY_LABELS[article.category] || article.category || 'Bài viết';
        
        // Use slug URL if available
        const articleUrl = article.slug && article.platform 
          ? `/${article.platform}/${article.slug}`
          : `/article.html?id=${article.id}`;
        
        return `
          <a href="${articleUrl}" class="article-card">
            <div class="article-card-thumb-wrap">
              <img src="${thumbSrc}" alt="${escapeHtml(article.title)}" class="article-card-thumb" loading="lazy">
              <span class="article-card-category">${categoryLabel}</span>
            </div>
            <div class="article-card-body">
              <h3 class="article-card-title">${escapeHtml(article.title)}</h3>
              ${article.description ? `<p class="article-card-desc">${escapeHtml(article.description)}</p>` : ''}
            </div>
          </a>
        `;
      }).join('');
    }
    
    function formatDate(timestamp) {
      if (!timestamp) return 'Mới cập nhật';
      try {
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric' });
      } catch {
        return 'Mới cập nhật';
      }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Search
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query.length >= 2) {
          window.location.href = `/search.html?q=${encodeURIComponent(query)}`;
        }
      }
    });
    
    loadArticles();
  </script>
</body>
</html>

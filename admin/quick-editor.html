<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Quick Editor - VietShare Admin</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="../assets/css/style.css">
  
  <!-- Marked.js for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Dark Mode -->
  <script src="../js/dark-mode.js"></script>
  
  <style>
    .quick-editor-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-xl);
      min-height: calc(100vh - 200px);
    }
    
    .editor-pane {
      display: flex;
      flex-direction: column;
    }
    
    .editor-pane h3 {
      margin-bottom: var(--spacing-md);
      font-size: 1rem;
    }
    
    .markdown-input {
      flex: 1;
      min-height: 500px;
      font-family: 'JetBrains Mono', Consolas, monospace;
      font-size: 0.875rem;
      line-height: 1.6;
      resize: none;
      padding: var(--spacing-md);
      border: 2px solid var(--color-border);
      background: var(--color-bg);
    }
    
    .markdown-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }
    
    .preview-pane {
      background: var(--color-bg);
      padding: var(--spacing-lg);
      border: 2px solid var(--color-border);
      overflow-y: auto;
      max-height: calc(100vh - 250px);
    }
    
    .preview-pane h1 { font-size: 1.75rem; margin-bottom: var(--spacing-md); }
    .preview-pane h2 { font-size: 1.375rem; margin-top: var(--spacing-lg); margin-bottom: var(--spacing-sm); }
    .preview-pane p { margin-bottom: var(--spacing-md); color: var(--color-text-secondary); }
    .preview-pane ul, .preview-pane ol { margin-left: var(--spacing-lg); margin-bottom: var(--spacing-md); }
    .preview-pane li { margin-bottom: var(--spacing-xs); color: var(--color-text-secondary); }
    
    .format-template {
      background: var(--color-bg-dark);
      padding: var(--spacing-md);
      border-left: 4px solid var(--color-accent);
      margin-bottom: var(--spacing-lg);
      font-size: 0.8125rem;
    }
    
    .format-template pre {
      background: #1E293B; /* Fixed dark - kh√¥ng d√πng variable */
      color: #E2E8F0;
      padding: var(--spacing-md);
      overflow-x: auto;
      margin-top: var(--spacing-sm);
      font-size: 0.75rem;
    }
    
    .parsed-info {
      background: var(--color-bg-alt);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      border: 1px solid var(--color-border);
    }
    
    .parsed-info-row {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      font-size: 0.875rem;
    }
    
    .parsed-info-label {
      font-weight: 600;
      min-width: 100px;
      color: var(--color-text-muted);
    }
    
    .parsed-info-value {
      color: var(--color-text);
    }
    
    @media (max-width: 1024px) {
      .quick-editor-layout {
        grid-template-columns: 1fr;
      }
      
      .markdown-input {
        min-height: 300px;
      }
      
      .preview-pane {
        max-height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="admin-sidebar-logo">VietShare</div>
      <ul class="admin-nav">
        <li><a href="/admin/index.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
          <span>Dashboard</span>
        </a></li>
        <li><a href="/admin/articles.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <span>B√†i vi·∫øt</span>
        </a></li>
        <li><a href="/admin/editor.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          <span>Editor WYSIWYG</span>
        </a></li>
        <li><a href="/admin/quick-editor.html" class="active">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M9 9h6"/><path d="M9 13h6"/><path d="M9 17h4"/></svg>
          <span>Quick Paste</span>
        </a></li>
        <li><a href="/admin/categories.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          <span>Danh m·ª•c</span>
        </a></li>
        <li><a href="/admin/sitemap.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
          <span>Sitemap</span>
        </a></li>
      </ul>
      
      <div style="margin-top: auto; padding-top: var(--spacing-xl);">
        <a href="/" style="display: block; padding: var(--spacing-sm); color: rgba(255,255,255,0.5); font-size: 0.875rem;">
          ‚Üê Xem trang web
        </a>
        <button id="logoutBtn" class="btn btn-secondary" style="width: 100%; margin-top: var(--spacing-sm);">
          ƒêƒÉng xu·∫•t
        </button>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header flex items-center justify-between">
        <h1 class="admin-title">Quick Paste Editor</h1>
        <div class="flex gap-md">
          <button class="btn btn-secondary" id="clearBtn">X√≥a</button>
          <button class="btn btn-primary" id="publishBtn">ƒêƒÉng b√†i</button>
        </div>
      </div>
      
      <!-- Image Upload -->
      <div class="image-upload-section" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--color-bg-alt); border: 1px solid var(--color-border);">
        <div style="display: flex; align-items: center; gap: var(--spacing-lg);">
          <div style="flex: 1;">
            <label style="display: block; font-weight: 600; margin-bottom: var(--spacing-sm);">·∫¢nh ƒë·∫°i di·ªán b√†i vi·∫øt</label>
            <input type="file" id="imageUpload" accept="image/*" style="width: 100%;">
            <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: var(--spacing-xs);">Ho·∫∑c nh·∫≠p URL tr·ª±c ti·∫øp trong frontmatter</p>
          </div>
          <div id="imagePreview" style="width: 120px; height: 80px; background: var(--color-bg-dark); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: var(--color-text-muted);">
            No image
          </div>
        </div>
      </div>
      
      <!-- Format Template - AI Friendly -->
      <div class="format-template">
        <strong>üìã Format m·∫´u cho AI:</strong> Copy format n√†y cho AI ƒë·ªÉ vi·∫øt b√†i vi·∫øt. Ch·ªçn 1 platform v√† 1 category ph√π h·ª£p.
        <pre>---
title: [Ti√™u ƒë·ªÅ h·∫•p d·∫´n, t·ªëi ƒëa 60 k√Ω t·ª±]
description: [M√¥ t·∫£ SEO 130-155 k√Ω t·ª±, g·ª£i gi√° tr·ªã cho ng∆∞·ªùi ƒë·ªçc]
platform: [CH·ªåN 1: zalo-pc | zalo-web | zalo-mobile]
category: [CH·ªåN 1: loi | vi-sao | meo | huong-dan]
tags: [t·ª´ kh√≥a 1, t·ª´ kh√≥a 2, t·ª´ kh√≥a 3]
---

## Gi·ªõi thi·ªáu
[1-2 c√¢u m√¥ t·∫£ v·∫•n ƒë·ªÅ/ch·ªß ƒë·ªÅ]

## Nguy√™n nh√¢n / Chi ti·∫øt
[Gi·∫£i th√≠ch r√µ r√†ng v·ªõi bullet points n·∫øu c·∫ßn]

## C√°ch th·ª±c hi·ªán / Kh·∫Øc ph·ª•c
### B∆∞·ªõc 1: [T√™n b∆∞·ªõc]
[H∆∞·ªõng d·∫´n chi ti·∫øt]

### B∆∞·ªõc 2: [T√™n b∆∞·ªõc]
[H∆∞·ªõng d·∫´n chi ti·∫øt]

## L∆∞u √Ω quan tr·ªçng
- [L∆∞u √Ω 1]
- [L∆∞u √Ω 2]

## K·∫øt lu·∫≠n
[T√≥m t·∫Øt v√† call-to-action]</pre>
        
        <div style="margin-top: var(--spacing-md); font-size: 0.8125rem;">
          <strong>üìÇ Platforms:</strong> <code>zalo-pc</code> = Zalo tr√™n m√°y t√≠nh | <code>zalo-web</code> = Zalo tr√¨nh duy·ªát | <code>zalo-mobile</code> = Zalo ƒëi·ªán tho·∫°i<br>
          <strong>üìÅ Categories:</strong> <code>loi</code> = L·ªói & kh·∫Øc ph·ª•c | <code>vi-sao</code> = Gi·∫£i th√≠ch t·∫°i sao | <code>meo</code> = M·∫πo hay | <code>huong-dan</code> = H∆∞·ªõng d·∫´n t·ª´ng b∆∞·ªõc
        </div>
      </div>
      
      <!-- Parsed Info -->
      <div class="parsed-info" id="parsedInfo" style="display: none;">
        <div class="parsed-info-row">
          <span class="parsed-info-label">Ti√™u ƒë·ªÅ:</span>
          <span class="parsed-info-value" id="parsedTitle">-</span>
        </div>
        <div class="parsed-info-row">
          <span class="parsed-info-label">M√¥ t·∫£:</span>
          <span class="parsed-info-value" id="parsedDesc">-</span>
        </div>
        <div class="parsed-info-row">
          <span class="parsed-info-label">N·ªÅn t·∫£ng:</span>
          <span class="parsed-info-value" id="parsedPlatform">-</span>
        </div>
        <div class="parsed-info-row">
          <span class="parsed-info-label">Danh m·ª•c:</span>
          <span class="parsed-info-value" id="parsedCategory">-</span>
        </div>
        <div class="parsed-info-row">
          <span class="parsed-info-label">Tags:</span>
          <span class="parsed-info-value" id="parsedTags">-</span>
        </div>
        <div class="parsed-info-row">
          <span class="parsed-info-label">·∫¢nh:</span>
          <span class="parsed-info-value" id="parsedImage">-</span>
        </div>
      </div>
      
      <!-- Editor Layout -->
      <div class="quick-editor-layout">
        <div class="editor-pane">
          <h3>Markdown Input</h3>
          <textarea class="markdown-input" id="markdownInput" placeholder="Paste n·ªôi dung theo format ·ªü tr√™n..."></textarea>
        </div>
        
        <div class="editor-pane">
          <h3>Preview</h3>
          <div class="preview-pane article-content" id="previewPane">
            <p class="text-muted">Preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
          </div>
        </div>
      </div>
      
      <div id="saveStatus" class="mt-lg text-center"></div>
    </main>
  </div>
  
  <script type="module">
    import { 
      auth, db, onAuthStateChanged, signOut, 
      collection, addDoc, cloudinaryConfig
    } from '../js/firebase-config.js';
    import { serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    let parsedData = null;
    let uploadedImageUrl = '';
    
    // Auth check
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = '/admin/login.html';
      }
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = '/admin/login.html';
    });
    
    // Image upload handler
    document.getElementById('imageUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const previewEl = document.getElementById('imagePreview');
      const parsedImageEl = document.getElementById('parsedImage');
      
      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        previewEl.innerHTML = '<span style="color: var(--color-error); font-size: 0.625rem;">·∫¢nh qu√° l·ªõn (max 5MB)</span>';
        parsedImageEl.textContent = '‚úó L·ªói';
        return;
      }
      
      // Show uploading status
      previewEl.innerHTML = '<span style="font-size: 0.625rem;">Uploading...</span>';
      parsedImageEl.textContent = 'ƒêang upload...';
      
      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', cloudinaryConfig.uploadPreset);
        
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        if (data.secure_url) {
          uploadedImageUrl = data.secure_url;
          previewEl.innerHTML = `<img src="${uploadedImageUrl}" style="width: 100%; height: 100%; object-fit: cover;">`;
          parsedImageEl.textContent = '‚úì ƒê√£ upload';
        } else {
          throw new Error(data.error?.message || 'Upload failed');
        }
      } catch (error) {
        console.error('Upload error:', error);
        uploadedImageUrl = ''; // Clear - don't use data URL
        previewEl.innerHTML = '<span style="color: var(--color-error); font-size: 0.6rem;">Upload l·ªói - th·ª≠ ·∫£nh kh√°c</span>';
        parsedImageEl.textContent = '‚úó L·ªói upload';
        alert('Kh√¥ng th·ªÉ upload ·∫£nh. Vui l√≤ng th·ª≠ ·∫£nh kh√°c ho·∫∑c ƒëƒÉng b√†i kh√¥ng c√≥ ·∫£nh.');
      }
    });
    
    // Parse frontmatter
    function parseFrontmatter(text) {
      // Trim leading whitespace to be more flexible
      const trimmedText = text.trim();
      const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)/;
      const match = trimmedText.match(frontmatterRegex);
      
      if (!match) {
        return { metadata: {}, content: trimmedText };
      }
      
      const frontmatter = match[1];
      const content = match[2];
      
      const metadata = {};
      frontmatter.split('\n').forEach(line => {
        const colonIndex = line.indexOf(':');
        if (colonIndex > 0) {
          const key = line.substring(0, colonIndex).trim();
          const value = line.substring(colonIndex + 1).trim();
          metadata[key] = value;
        }
      });
      
      return { metadata, content };
    }
    
    // Update preview
    function updatePreview() {
      const input = document.getElementById('markdownInput').value;
      const previewPane = document.getElementById('previewPane');
      const parsedInfo = document.getElementById('parsedInfo');
      
      if (!input.trim()) {
        previewPane.innerHTML = '<p class="text-muted">Preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>';
        parsedInfo.style.display = 'none';
        parsedData = null;
        return;
      }
      
      const { metadata, content } = parseFrontmatter(input);
      
      // Update parsed info display
      if (Object.keys(metadata).length > 0) {
        parsedInfo.style.display = 'block';
        document.getElementById('parsedTitle').textContent = metadata.title || '-';
        document.getElementById('parsedDesc').textContent = metadata.description || '-';
        document.getElementById('parsedPlatform').textContent = getPlatformLabel(metadata.platform) || '-';
        document.getElementById('parsedCategory').textContent = getCategoryLabel(metadata.category) || '-';
        document.getElementById('parsedTags').textContent = metadata.tags || '-';
        
        // Check for uploaded image or frontmatter image
        if (uploadedImageUrl) {
          document.getElementById('parsedImage').textContent = '‚úì ƒê√£ upload';
        } else {
          document.getElementById('parsedImage').textContent = '-';
        }
        
        parsedData = {
          title: metadata.title || '',
          description: metadata.description || '',
          platform: metadata.platform || 'zalo-pc',
          category: metadata.category || 'meo',
          tags: metadata.tags ? metadata.tags.split(',').map(t => t.trim()) : [],
          content: content
        };
      } else {
        parsedInfo.style.display = 'none';
        parsedData = {
          title: '',
          description: '',
          platform: 'zalo-pc',
          category: 'meo',
          tags: [],
          content: input
        };
      }
      
      // Render markdown
      previewPane.innerHTML = marked.parse(content);
    }
    
    function getPlatformLabel(platform) {
      const labels = {
        'zalo-pc': 'Zalo PC',
        'zalo-web': 'Zalo Web',
        'zalo-mobile': 'Zalo Mobile'
      };
      return labels[platform] || platform;
    }
    
    function getCategoryLabel(category) {
      const labels = {
        'loi': 'L·ªói',
        'vi-sao': 'V√¨ sao',
        'meo': 'M·∫πo',
        'huong-dan': 'H∆∞·ªõng d·∫´n'
      };
      return labels[category] || category;
    }
    
    // Publish article
    async function publishArticle() {
      if (!parsedData || !parsedData.title) {
        alert('Vui l√≤ng nh·∫≠p n·ªôi dung v·ªõi format ƒë√∫ng (c√≥ title trong frontmatter)');
        return;
      }
      
      const statusEl = document.getElementById('saveStatus');
      statusEl.textContent = 'ƒêang ƒëƒÉng b√†i...';
      statusEl.style.color = 'var(--color-text-muted)';
      
      try {
        // Convert markdown content to HTML
        const htmlContent = marked.parse(parsedData.content);
        
        const articleData = {
          title: parsedData.title,
          description: parsedData.description,
          platform: parsedData.platform,
          category: parsedData.category,
          tags: parsedData.tags,
          heroImage: uploadedImageUrl || '',
          content: htmlContent,
          status: 'published',
          views: 0,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        const docRef = await addDoc(collection(db, 'articles'), articleData);
        
        statusEl.textContent = '‚úì ƒê√£ ƒëƒÉng b√†i th√†nh c√¥ng!';
        statusEl.style.color = 'var(--color-success)';
        
        // Clear editor
        document.getElementById('markdownInput').value = '';
        document.getElementById('imageUpload').value = '';
        document.getElementById('imagePreview').innerHTML = 'No image';
        uploadedImageUrl = '';
        updatePreview();
        
        setTimeout(() => {
          statusEl.textContent = '';
        }, 5000);
      } catch (error) {
        console.error('Error publishing:', error);
        statusEl.textContent = '‚úó L·ªói khi ƒëƒÉng b√†i: ' + error.message;
        statusEl.style.color = 'var(--color-error)';
      }
    }
    
    // Clear editor
    function clearEditor() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a n·ªôi dung?')) {
        document.getElementById('markdownInput').value = '';
        document.getElementById('imageUpload').value = '';
        document.getElementById('imagePreview').innerHTML = 'No image';
        uploadedImageUrl = '';
        updatePreview();
      }
    }
    
    // Event listeners
    document.getElementById('markdownInput').addEventListener('input', updatePreview);
    document.getElementById('publishBtn').addEventListener('click', publishArticle);
    document.getElementById('clearBtn').addEventListener('click', clearEditor);
    
    // Initial preview update
    updatePreview();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Viết bài - VietShare Admin</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Quill Editor -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="../assets/css/style.css">
  
  <!-- Dark Mode -->
  <script src="../js/dark-mode.js"></script>
  
  <style>
    .editor-container {
      background: var(--color-bg);
      min-height: 400px;
    }
    
    .ql-toolbar {
      border: 1px solid var(--color-border) !important;
      border-radius: 0 !important;
    }
    
    .ql-container {
      border: 1px solid var(--color-border) !important;
      border-top: none !important;
      border-radius: 0 !important;
      font-family: var(--font-primary) !important;
      font-size: 1rem !important;
    }
    
    .ql-editor {
      min-height: 350px;
    }
    
    .image-preview {
      max-width: 300px;
      margin-top: var(--spacing-sm);
      display: none;
    }
    
    .save-status {
      font-size: 0.875rem;
      margin-left: var(--spacing-md);
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="admin-sidebar-logo">VietShare</div>
      <ul class="admin-nav">
        <li><a href="/admin/index.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
          <span>Dashboard</span>
        </a></li>
        <li><a href="/admin/articles.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <span>Bài viết</span>
        </a></li>
        <li><a href="/admin/editor.html" class="active">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          <span>Viết bài</span>
        </a></li>
        <li><a href="/admin/quick-editor.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M9 9h6"/><path d="M9 13h6"/><path d="M9 17h4"/></svg>
          <span>Quick Paste</span>
        </a></li>
        <li><a href="/admin/categories.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          <span>Danh mục</span>
        </a></li>
      </ul>
      
      <div style="margin-top: auto; padding-top: var(--spacing-xl);">
        <a href="/" style="display: block; padding: var(--spacing-sm); color: rgba(255,255,255,0.5); font-size: 0.875rem;">
          ← Xem trang web
        </a>
        <button id="logoutBtn" class="btn btn-secondary" style="width: 100%; margin-top: var(--spacing-sm);">
          Đăng xuất
        </button>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header flex items-center justify-between">
        <h1 class="admin-title" id="pageTitle">Viết bài mới</h1>
        <div class="flex items-center">
          <span class="save-status" id="saveStatus"></span>
        </div>
      </div>
      
      <form id="articleForm">
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: var(--spacing-xl);">
          <!-- Main Editor -->
          <div>
            <div class="form-group">
              <label class="form-label" for="title">Tiêu đề (H1)</label>
              <input type="text" class="form-input" id="title" placeholder="Ví dụ: Cách ẩn trạng thái online Zalo" required>
              <small class="text-muted">45-65 ký tự, có động từ hành động</small>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="description">Mô tả ngắn (Meta description)</label>
              <textarea class="form-textarea" id="description" rows="2" placeholder="130-155 ký tự mô tả bài viết" required style="min-height: 80px;"></textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label">Nội dung</label>
              <div class="editor-container">
                <div id="editor"></div>
              </div>
            </div>
          </div>
          
          <!-- Sidebar -->
          <div>
            <!-- Publish Box -->
            <div style="background: var(--color-bg); padding: var(--spacing-md); border-left: 4px solid var(--color-accent); margin-bottom: var(--spacing-md);">
              <h3 style="font-size: 1rem; margin-bottom: var(--spacing-md);">Đăng bài</h3>
              
              <div class="form-group">
                <label class="form-label" for="status">Trạng thái</label>
                <select class="form-select" id="status">
                  <option value="draft">Bản nháp</option>
                  <option value="published">Đã đăng</option>
                </select>
              </div>
              
              <div class="flex gap-sm">
                <button type="button" class="btn btn-secondary" id="saveDraftBtn" style="flex: 1;">Lưu nháp</button>
                <button type="submit" class="btn btn-primary" id="publishBtn" style="flex: 1;">Đăng bài</button>
              </div>
              
              <button type="button" class="btn btn-secondary text-error mt-md" id="deleteBtn" style="width: 100%; display: none;">
                Xóa bài viết
              </button>
            </div>
            
            <!-- Category -->
            <div style="background: var(--color-bg); padding: var(--spacing-md); border-left: 4px solid var(--color-border); margin-bottom: var(--spacing-md);">
              <h3 style="font-size: 1rem; margin-bottom: var(--spacing-md);">Phân loại</h3>
              
              <div class="form-group">
                <label class="form-label" for="platform">Nền tảng</label>
                <select class="form-select" id="platform">
                  <option value="zalo-pc">Zalo PC</option>
                  <option value="zalo-web">Zalo Web</option>
                  <option value="zalo-mobile">Zalo Mobile</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label" for="category">Danh mục</label>
                <select class="form-select" id="category">
                  <option value="loi">Lỗi</option>
                  <option value="vi-sao">Vì sao</option>
                  <option value="meo">Mẹo</option>
                  <option value="huong-dan">Hướng dẫn</option>
                </select>
              </div>
              
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="tags">Tags (phân cách bằng dấu phẩy)</label>
                <input type="text" class="form-input" id="tags" placeholder="zalo, ẩn online, mẹo">
              </div>
            </div>
            
            <!-- Hero Image -->
            <div style="background: var(--color-bg); padding: var(--spacing-md); border-left: 4px solid var(--color-border);">
              <h3 style="font-size: 1rem; margin-bottom: var(--spacing-md);">Ảnh đại diện</h3>
              
              <div class="form-group">
                <input type="file" id="heroImageFile" accept="image/*" style="display: none;">
                <button type="button" class="btn btn-secondary" id="uploadImageBtn" style="width: 100%;">
                  Tải ảnh lên
                </button>
                <input type="hidden" id="heroImage">
                <img id="imagePreview" class="image-preview" src="" alt="Preview">
              </div>
              
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="heroImageUrl">Hoặc nhập URL ảnh</label>
                <input type="url" class="form-input" id="heroImageUrl" placeholder="https://res.cloudinary.com/...">
              </div>
            </div>
          </div>
        </div>
      </form>
    </main>
  </div>
  
  <!-- Quill Editor -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  
  <script type="module">
    import { 
      auth, db, onAuthStateChanged, signOut, 
      collection, doc, getDoc, addDoc, updateDoc, deleteDoc,
      cloudinaryConfig 
    } from '../js/firebase-config.js';
    import { serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    let quill;
    let currentArticleId = null;
    
    // Auth check
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = '/admin/login.html';
      } else {
        initEditor();
      }
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = '/admin/login.html';
    });
    
    // Initialize Editor
    async function initEditor() {
      quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Viết nội dung bài viết...',
        modules: {
          toolbar: [
            [{ 'header': [2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link', 'image'],
            ['clean']
          ]
        }
      });
      
      // Check if editing existing article
      const urlParams = new URLSearchParams(window.location.search);
      currentArticleId = urlParams.get('id');
      
      if (currentArticleId) {
        await loadArticle(currentArticleId);
        document.getElementById('pageTitle').textContent = 'Chỉnh sửa bài viết';
        document.getElementById('deleteBtn').style.display = 'block';
      }
    }
    
    // Load existing article
    async function loadArticle(id) {
      try {
        const articleRef = doc(db, 'articles', id);
        const snapshot = await getDoc(articleRef);
        
        if (snapshot.exists()) {
          const article = snapshot.data();
          
          document.getElementById('title').value = article.title || '';
          document.getElementById('description').value = article.description || '';
          document.getElementById('platform').value = article.platform || 'zalo-pc';
          document.getElementById('category').value = article.category || 'meo';
          document.getElementById('status').value = article.status || 'draft';
          document.getElementById('tags').value = (article.tags || []).join(', ');
          
          if (article.heroImage) {
            document.getElementById('heroImage').value = article.heroImage;
            document.getElementById('heroImageUrl').value = article.heroImage;
            document.getElementById('imagePreview').src = article.heroImage;
            document.getElementById('imagePreview').style.display = 'block';
          }
          
          quill.root.innerHTML = article.content || '';
        }
      } catch (error) {
        console.error('Error loading article:', error);
        alert('Không thể tải bài viết.');
      }
    }
    
    // Save article
    async function saveArticle(status) {
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const platform = document.getElementById('platform').value;
      const category = document.getElementById('category').value;
      const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
      const heroImage = document.getElementById('heroImageUrl').value.trim() || document.getElementById('heroImage').value;
      const content = quill.root.innerHTML;
      
      if (!title) {
        alert('Vui lòng nhập tiêu đề.');
        return;
      }
      
      const articleData = {
        title,
        description,
        platform,
        category,
        tags,
        heroImage,
        content,
        status,
        updatedAt: serverTimestamp()
      };
      
      try {
        document.getElementById('saveStatus').textContent = 'Đang lưu...';
        
        if (currentArticleId) {
          const articleRef = doc(db, 'articles', currentArticleId);
          await updateDoc(articleRef, articleData);
        } else {
          articleData.createdAt = serverTimestamp();
          const docRef = await addDoc(collection(db, 'articles'), articleData);
          currentArticleId = docRef.id;
          window.history.replaceState({}, '', `/admin/editor.html?id=${currentArticleId}`);
          document.getElementById('deleteBtn').style.display = 'block';
        }
        
        document.getElementById('saveStatus').textContent = status === 'published' ? 'Đã đăng!' : 'Đã lưu!';
        document.getElementById('saveStatus').style.color = 'var(--color-success)';
        
        setTimeout(() => {
          document.getElementById('saveStatus').textContent = '';
        }, 3000);
      } catch (error) {
        console.error('Error saving article:', error);
        document.getElementById('saveStatus').textContent = 'Lỗi khi lưu!';
        document.getElementById('saveStatus').style.color = 'var(--color-error)';
      }
    }
    
    // Delete article
    async function deleteArticle() {
      if (!currentArticleId) return;
      
      if (!confirm('Bạn có chắc muốn xóa bài viết này?')) return;
      
      try {
        const articleRef = doc(db, 'articles', currentArticleId);
        await deleteDoc(articleRef);
        window.location.href = '/admin/articles.html';
      } catch (error) {
        console.error('Error deleting article:', error);
        alert('Không thể xóa bài viết.');
      }
    }
    
    // Image upload to Cloudinary
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', cloudinaryConfig.uploadPreset);
      
      try {
        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`,
          { method: 'POST', body: formData }
        );
        
        const data = await response.json();
        return data.secure_url;
      } catch (error) {
        console.error('Error uploading image:', error);
        return null;
      }
    }
    
    // Event Listeners
    document.getElementById('articleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveArticle('published');
    });
    
    document.getElementById('saveDraftBtn').addEventListener('click', async () => {
      await saveArticle('draft');
    });
    
    document.getElementById('deleteBtn').addEventListener('click', deleteArticle);
    
    document.getElementById('uploadImageBtn').addEventListener('click', () => {
      document.getElementById('heroImageFile').click();
    });
    
    document.getElementById('heroImageFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      document.getElementById('uploadImageBtn').textContent = 'Đang tải...';
      document.getElementById('uploadImageBtn').disabled = true;
      
      const imageUrl = await uploadImage(file);
      
      if (imageUrl) {
        document.getElementById('heroImage').value = imageUrl;
        document.getElementById('heroImageUrl').value = imageUrl;
        document.getElementById('imagePreview').src = imageUrl;
        document.getElementById('imagePreview').style.display = 'block';
      }
      
      document.getElementById('uploadImageBtn').textContent = 'Tải ảnh lên';
      document.getElementById('uploadImageBtn').disabled = false;
    });
    
    document.getElementById('heroImageUrl').addEventListener('change', (e) => {
      const url = e.target.value.trim();
      if (url) {
        document.getElementById('imagePreview').src = url;
        document.getElementById('imagePreview').style.display = 'block';
      }
    });
  </script>
</body>
</html>

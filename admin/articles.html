<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>Qu·∫£n l√Ω b√†i vi·∫øt - VietShare Admin</title>
  <link rel="icon" type="image/png" href="../favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="admin.css">
  <style>.admin-layout { display: none; }</style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <a href="../index.html" class="logo">
          <img src="/favicon.png" alt="VietShare" style="width:40px;height:40px;">
          <span class="logo-text">VietShare</span>
        </a>
      </div>
      <nav class="sidebar-nav">
        <a href="index.html" class="nav-item"><i data-lucide="layout-dashboard"></i> Dashboard</a>
        <a href="editor.html" class="nav-item"><i data-lucide="edit-3"></i> Vi·∫øt b√†i m·ªõi</a>
        <a href="articles.html" class="nav-item active"><i data-lucide="file-text"></i> Qu·∫£n l√Ω b√†i vi·∫øt</a>
        <a href="categories.html" class="nav-item"><i data-lucide="folder"></i> Danh m·ª•c</a>
      </nav>
      <div class="sidebar-footer">
        <button class="nav-item" id="logoutBtn"><i data-lucide="log-out"></i> ƒêƒÉng xu·∫•t</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <header class="admin-header">
        <h1>Qu·∫£n l√Ω b√†i vi·∫øt</h1>
        <a href="editor.html" class="btn btn-primary"><i data-lucide="plus"></i> Vi·∫øt b√†i m·ªõi</a>
      </header>

      <div class="admin-section" style="margin-bottom:1.5rem;">
        <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:center;">
          <select class="form-select" id="filterStatus" style="width:auto;">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="published">‚úÖ ƒê√£ ƒëƒÉng</option>
            <option value="draft">‚úèÔ∏è B·∫£n nh√°p</option>
          </select>
          <select class="form-select" id="filterCategory" style="width:auto;">
            <option value="">ƒêang t·∫£i...</option>
          </select>
          <input type="text" class="form-input" id="searchInput" placeholder="T√¨m ki·∫øm b√†i vi·∫øt..." style="width:300px;">
          <span id="totalCount" style="color:var(--text-muted);margin-left:auto;">T·ªïng: 0 b√†i vi·∫øt</span>
        </div>
      </div>

      <!-- Articles Table -->
      <div class="admin-section">
        <div class="articles-table" id="articlesTable">
          <div class="loading"><div class="loading-spinner"></div><span>ƒêang t·∫£i...</span></div>
        </div>
      </div>
      
      <!-- Pagination -->
      <div class="pagination" id="pagination" style="margin-top:1.5rem;"></div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
      
      if (!window.VietShare || !window.VietShare.auth || !window.VietShare.db) {
        document.body.innerHTML = '<div style="padding:2rem;text-align:center;"><h2>L·ªói t·∫£i Firebase</h2><p><a href="login.html">Quay l·∫°i ƒëƒÉng nh·∫≠p</a></p></div>';
        return;
      }

      var db = window.VietShare.db;
      var auth = window.VietShare.auth;
      var formatDate = window.VietShare.formatDate;
      var getCategoryInfo = window.VietShare.getCategoryInfo;
      var showToast = window.VietShare.showToast;
      
      var adminLayout = document.querySelector('.admin-layout');
      var allArticles = [];
      var currentPage = 1;
      var perPage = 15;

      // Auth check
      auth.onAuthStateChanged(function(user) {
        if (!user) {
          window.location.href = 'login.html';
        } else {
          adminLayout.style.display = 'grid';
          loadArticles();
        }
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', function() {
        auth.signOut().then(function() {
          window.location.href = 'login.html';
        });
      });

      // Load articles
      async function loadArticles() {
        // Load dynamic categories
        await window.VietShare.loadCategories();
        var cats=window.VietShare.CATEGORIES;
        var catSelect=document.getElementById('filterCategory');
        catSelect.innerHTML='<option value="">T·∫•t c·∫£ danh m·ª•c</option>';
        Object.keys(cats).forEach(function(key){
          var c=cats[key];
          catSelect.innerHTML+='<option value="'+key+'">'+(c.icon||'üìÅ')+' '+c.name+'</option>';
        });

        db.collection('articles').orderBy('updatedAt', 'desc').get()
          .then(function(snapshot) {
            allArticles = snapshot.docs.map(function(doc) {
              return { id: doc.id, ...doc.data() };
            });
            renderArticles();
          })
          .catch(function(error) {
            console.error(error);
            document.getElementById('articlesTable').innerHTML = '<div class="empty-state"><p>L·ªói t·∫£i d·ªØ li·ªáu</p></div>';
          });
      }

      // Filter and search
      document.getElementById('filterCategory').addEventListener('change', renderArticles);
      document.getElementById('filterStatus').addEventListener('change', renderArticles);
      document.getElementById('searchInput').addEventListener('input', renderArticles);

      function renderArticles() {
        var category = document.getElementById('filterCategory').value;
        var status = document.getElementById('filterStatus').value;
        var search = document.getElementById('searchInput').value.toLowerCase();
        
        var filtered = allArticles.filter(function(a) {
          var matchCategory = !category || a.category === category;
          var matchStatus = !status || a.status === status;
          var matchSearch = !search || a.title.toLowerCase().includes(search);
          return matchCategory && matchStatus && matchSearch;
        });

        document.getElementById('totalCount').textContent = 'T·ªïng: ' + filtered.length + ' b√†i vi·∫øt';
        
        var container = document.getElementById('articlesTable');
        
        if (filtered.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>Kh√¥ng c√≥ b√†i vi·∫øt n√†o</p><a href="editor.html" class="btn btn-primary">Vi·∫øt b√†i ƒë·∫ßu ti√™n</a></div>';
          document.getElementById('pagination').innerHTML = '';
          return;
        }

        var start = (currentPage - 1) * perPage;
        var paged = filtered.slice(start, start + perPage);

        container.innerHTML = '<table>' +
          '<thead><tr><th style="width:60px">·∫¢nh</th><th style="width:30%">Ti√™u ƒë·ªÅ</th><th>Danh m·ª•c</th><th>Tr·∫°ng th√°i</th><th>L∆∞·ª£t xem</th><th>C·∫≠p nh·∫≠t</th><th>Thao t√°c</th></tr></thead>' +
          '<tbody>' + paged.map(function(a) {
            var cat = getCategoryInfo(a.category);
            var statusBadge = a.status === 'draft' 
              ? '<span class="badge" style="background:#fef3c7;color:#d97706;">Nh√°p</span>'
              : '<span class="badge" style="background:#dcfce7;color:#16a34a;">ƒê√£ ƒëƒÉng</span>';
            var thumbSrc = a.thumbnail || 'https://placehold.co/60x40?text=No+Image';
            return '<tr>' +
              '<td><img src="' + thumbSrc + '" style="width:60px;height:40px;object-fit:cover;border-radius:4px;" onerror="this.src=\'https://placehold.co/60x40?text=Error\'"></td>' +
              '<td class="title-cell"><a href="../article.html?slug=' + a.slug + '" target="_blank">' + a.title + '</a>' + 
              (a.featured ? ' <span style="color:gold;">‚òÖ</span>' : '') + '</td>' +
              '<td><span class="badge">' + cat.name + '</span></td>' +
              '<td>' + statusBadge + '</td>' +
              '<td>' + (a.views || 0) + '</td>' +
              '<td>' + formatDate(a.updatedAt || a.publishedAt) + '</td>' +
              '<td class="actions">' +
                '<a href="editor.html?id=' + a.id + '" class="btn-icon" title="S·ª≠a"><i data-lucide="edit"></i></a>' +
                '<button class="btn-icon delete" data-id="' + a.id + '" title="X√≥a"><i data-lucide="trash-2"></i></button>' +
              '</td>' +
            '</tr>';
          }).join('') + '</tbody></table>';

        lucide.createIcons();
        renderPagination(filtered.length);
        bindDeleteButtons();
      }

      function renderPagination(total) {
        var pages = Math.ceil(total / perPage);
        var paginationEl = document.getElementById('pagination');
        
        if (pages <= 1) {
          paginationEl.innerHTML = '';
          return;
        }

        var html = '';
        for (var i = 1; i <= pages; i++) {
          html += '<button class="pagination-btn ' + (i === currentPage ? 'active' : '') + '" data-page="' + i + '">' + i + '</button>';
        }
        paginationEl.innerHTML = html;

        paginationEl.querySelectorAll('.pagination-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            currentPage = parseInt(btn.dataset.page);
            renderArticles();
            window.scrollTo(0, 0);
          });
        });
      }

      function bindDeleteButtons() {
        document.querySelectorAll('.delete').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y?')) {
              db.collection('articles').doc(btn.dataset.id).delete()
                .then(function() {
                  showToast('ƒê√£ x√≥a b√†i vi·∫øt');
                  loadArticles();
                })
                .catch(function(e) {
                  showToast('L·ªói x√≥a b√†i vi·∫øt');
                });
            }
          });
        });
      }
    });
  </script>
</body>
</html>
